{% extends 'page.html' %}
{% load static %}
{% block title %}Detail Post{% endblock title %}
{% block content %}
<div class="card w-75 mx-auto mt-5">
  <h5 class="card-title m-5">{{post.title}}</h5>
  <div class="text-center">
    <img src="{{post.image.url}}" class="card-img-bottom w-75 h-75" alt="...">
  </div>
  <div class="card-body">
    <p class="card-text mt-3">{{post.content}}</p>
    <p class="card-text"><small class="text-body-secondary">{{post.date}}</small></p>
  </div>
</div>
<!--Comment-->
<div class="card mt-4 mb-5">
  <div class="card-header">
    <h5>Comments <i class="fa-regular fa-comments"></i></h5>
  </div>
  <div class="card-body">
    {% if user.is_authenticated %}
    <form method="post" id="form">
      {% csrf_token %}
      <input type="hidden" value="{{post.id}}" name="id">
      <div class="form-floating">
        <textarea class="form-control" name="comment" id="floatingTextarea2" style="height: 100px" required></textarea>
        <label for="floatingTextarea2">Comments</label>
      </div>
      <div class="d-flex justify-content-end mt-2">
        <button type="submit" class="btn btn-primary" onclick="saveComment(event)">Comment</button>
      </div>
    </form>
    {% else %}
    <p class="text-center">Sign in for comment this post.</p>
    {% endif %}
    {% if comments %}
    <div class="mt-5">
      {% for comment in comments %}
      <div class="card mt-3">
        <div class="card-body">
          <div class="row">
            <div class="col-md-2 d-flex justify-content-end">
              <img
                src="{% if comment.user.image %}/media/{{comment.user.image}} {% else %}{% static 'images/default.png' %}{% endif %}"
                class="rounded-circle" style="width: 50px; height:50px">
            </div>
            <div class="col-md-6">
              <small class="fs-5 fw-bold">{{comment.user.full_names}}</small> <br>
              <small>{{comment.date}}</small>
            </div>
            {% if user.is_authenticated %}
            {% if comment.user == user %}
            <div class="col-md-4 d-flex justify-content-end">
              <button class="btn" onclick="deleteComment({{ comment.id }})"><i class="fa-solid fa-x"
                  title="Delete"></i></button>
            </div>
            {% endif %}
            {% endif %}
            <div class="col-md-12">
              <p class="mt-2" style="margin-left: 150px;">{{comment.comment}}</p>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>
</div>
{% endblock content %}

{% block script %}
<script>
  // Create Comment
  const csrf_token = document.querySelector('input[name="csrfmiddlewaretoken"]').value
  async function saveComment(event) {
    event.preventDefault()
    const form = document.querySelector('#form')
    if (!form.checkValidity()) {
      form.reportValidity();
      return;  // Detener la ejecución si el formulario no es válido
    }
    const formData = new FormData(form)
    try {
      const response = await axios.post('{% url "post:comment" %}', formData, {
        headers: {
          'X-CSRFToken': csrf_token
        }
      })
      if (response.status === 200) {
        window.location.reload()
      }
    } catch (error) {
      console.log(error);
    }
  }
  // Delete Comment
  async function deleteComment(commentId) {
    swal({
      title: "Are you sure?",
      text: "Once deleted, you will not be able to recover this post!",
      icon: "warning",
      buttons: true,
      dangerMode: true,
    }).then(async (willDelete) => {
      if (willDelete) {
        try {
          const response = await axios.post('{% url "post:comment_delete" %}', { commentId }, {
            headers: {
              'X-CSRFToken': csrf_token
            }
          })
          if (response.status === 200) {
            window.location.reload()
          }
        } catch (error) {
          console.log(error);
        }
      }
    });

  }
</script>
{% endblock script %}
{% extends 'page.html' %}
{% block title %}Post{% endblock title %}
{% block content %}
<div class="table-responsive">
    <div class="mt-3 mb-5">
        <h3 class="float-start">Post Published</h3>
        <button class="btn btn-info float-end" id="btnModal">New Post</button>
    </div>
    {% if posts %}
    <table class="table table-striped table-hover mt-2">
        <thead class="table-dark">
            <tr>
                <th scope="col">Id</th>
                <th scope="col">Image</th>
                <th scope="col">Title</th>
                <th scope="col">Content</th>
                <th scope="col">Status</th>
                <th scope="col">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for post in posts %}
            <tr>
                <td>{{post.id}}</td>
                <td><img src="{{post.image.url}}" alt="{{post.title}}" style="width: 50px;"></td>
                <td>{{post.title}}</td>
                <td>{{post.content | truncatechars:50}}</td>
                <td>
                    {% if post.status %}
                    <span class="badge text-bg-success">Published</span>
                    {% else %}
                    <span class="badge text-bg-secondary">Hidden</span>
                    {% endif %}
                </td>
                <td>
                    <button class="btn btn-success btn-sm btnEdit"><i class="fa-regular fa-pen-to-square"></i></button>
                    <button class="btn btn-danger btn-sm btnDelete"><i class="fa-solid fa-trash"></i></button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-center">No hay Registros</p>
    {% endif %}
</div>
<!-- Modal -->
<div class="modal fade" id="modalForm" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="form" method="post" enctype="multipart/form-data">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="modalTitle"></h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    {% csrf_token %}
                    {% for field in form %}
                    <div class="mb-3">
                        <label class="form-class">{{field.label}}</label>
                        {{field}}
                    </div>
                    {% endfor %}

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn" id="btnAction"></button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock content %}
{% block script %}
<script>
    document.addEventListener('DOMContentLoaded', function () {

        //Global
        const csrf_token = document.querySelector('input[name="csrfmiddlewaretoken"]').value
        let url = ''
        let id = ''
        //Conf general modal
        function confModal(title, btnText, btnClass) {
            const modal = new bootstrap.Modal('#modalForm')
            const btnModal = document.querySelector('#btnModal')
            const modalTitle = document.querySelector('#modalTitle').innerHTML = title
            const btnAction = document.querySelector('#btnAction')
            btnAction.innerHTML = btnText
            if (btnAction.classList.contains('btn-primary')) {
                btnAction.classList.remove('btn-primary')
                btnAction.classList.add(btnClass)
            } else {
                btnAction.classList.remove('btn-success')
                btnAction.classList.add(btnClass)
            }
            modal.show()
        }

        btnModal.addEventListener('click', function () {
            confModal('Form Post', 'Save', 'btn-primary')
            url = '{% url "post:create" %}'
        })

        //Create or Update
        btnAction.addEventListener('click', async function (e) {
            e.preventDefault()
            const form = document.querySelector('#form')
            const formData = new FormData(form)
            formData.append('id', id)
            formData.append('csrf_token', csrf_token)
            try {
                const response = await axios.post(url, formData,
                    {
                        headers: {
                            'Content-Type': 'multipart/form-data',  // Especifica el tipo de contenido como 'multipart/form-data'
                            'X-CSRFToken': csrf_token  // Agrega el token CSRF al encabezado
                        }
                    }
                )
                if (response.status === 200) {
                    swal({
                        title: "¡Successful Action!",
                        text: "¡Post Created!",
                        type: "success",
                        icon: 'success',
                        confirmButtonText: "OK"
                    }).then(function () {
                        // Cuando el usuario haga clic en "OK", recarga la página
                        window.location.reload();
                    })
                } else {
                    console.log('PUTA MIERDA');
                }
            } catch (error) {
                console.log(error);
            }
        })

        //Edit
        const btnsEdit = document.querySelectorAll('.btnEdit')
        btnsEdit.forEach(btnEdit => {
            btnEdit.addEventListener('click', async function () {
                const row = this.closest('tr')
                const postId = row.querySelector('td:first-child').textContent
                url = '{% url "post:update" %}'
                id = postId
                try {
                    const response = await axios.post("{% url 'post:edit' %}", { id }, {
                        headers: {
                            'X-CSRFToken': csrf_token
                        }
                    })
                    if (response.status === 200) {
                        confModal('Edit Post', 'Update', 'btn-success')
                        const data = response.data.data
                        document.querySelector('#id_title').value = data.title
                        document.querySelector('#id_content').value = data.content
                    }
                } catch (error) {
                    console.log(error);
                }
            })
        })

        // Delete 
        const btnsDelete = document.querySelectorAll('.btnDelete')
        btnsDelete.forEach(btnDelete => {
            btnDelete.addEventListener('click', function () {
                const row = this.closest('tr')
                const id = row.querySelector('td:first-child').textContent
                swal({
                    title: "Are you sure?",
                    text: "Once deleted, you will not be able to recover this post!",
                    icon: "warning",
                    buttons: true,
                    dangerMode: true,
                }).then(async (willDelete) => {
                    if (willDelete) {
                        try {
                            const response = await axios.post('{% url "post:delete" %}', { id: id }, {
                                headers: {
                                    'X-CSRFToken': csrf_token
                                }
                            })
                            if (response.status === 200) {
                                window.location.reload()
                            }
                        } catch (error) {
                            console.log(error);
                        }
                    }
                });
            })
        });

    })
</script>
{% endblock script %}